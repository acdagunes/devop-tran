---
# ansible-cm/roles/nginx_web/tasks/main.yml
# FINAL VERSION: Using Docker Compose for simplicity and scalability
# 0. CLEANUP (must run before deployment attempts)
- name: 0. Ensure OLD Nginx container is stopped and removed (due to port conflict)
  community.docker.docker_container:
    name: nginx_web
    state: absent
  ignore_errors: true # იგნორირება თუ კონტეინერი არ არსებობს (პირველი გაშვებისას)
  tags: cleanup
# 1. Ensure the required directories exist on the Droplet for volume mounting
- name: 1. Ensure required directories exist for Compose volumes
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    # ეს არის Volumes-ის გარე (Droplet-ზე) ნაწილი
    - /home/root/nginx/html
  tags: deploy

# 2. Deploy index.html template directly to the volume path
- name: 2. Deploy index.html template directly to Compose volume path
  ansible.builtin.template:
    src: index.html.j2
    dest: /home/root/nginx/html/index.html
    owner: root
    group: root
    mode: '0644'
  tags: deploy

# 3. Copy docker-compose.yml file to the Droplet
- name: 3. Copy docker-compose.yml to Droplet
  ansible.builtin.copy:
    # ფაილი არის devops-lab/-ში, 4 დონე ზემოთ როლიდან
    src: ../../../../docker-compose.yml
    dest: /home/root/docker-compose.yml
    owner: root
    group: root
    mode: '0644'
  tags: deploy

# 4. Launch the services using docker compose
- name: 4. Launch Nginx container using Docker Compose CLI (V2)
  ansible.builtin.command:
    # Docker Compose V2 არის 'docker compose up -d' (სივრცით)
    cmd: docker compose -f /home/root/docker-compose.yml up -d
    chdir: /home/root/ # ბრძანება უნდა გაეშვას იქ, სადაც Compose ფაილია
  tags: deploy
