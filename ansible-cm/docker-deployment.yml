---
- name: Setup Docker and launch Nginx container
  hosts: web_servers
  become: yes
  gather_facts: yes

  

  tasks:
    # --------------------------------------------------------------------------
    # ეტაპი 1: Ubuntu-ს წინაპირობების ინსტალაცია
    # --------------------------------------------------------------------------
    - name: Update apt cache and install dependencies
      ansible.builtin.apt:
        name: 
          - curl
          - gnupg
          - lsb-release
          - ca-certificates
          - python3-pip # DNF-ის ნაცვლად ვიყენებთ APT-ს PIP-ისთვის
        state: present
        update_cache: yes
      tags: install_deps
      
    # --------------------------------------------------------------------------
    # ეტაპი 2: Python Docker SDK-ის ინსტალაცია (Droplet-ზე)
    # --------------------------------------------------------------------------
    - name: Install Python Docker SDK (required for docker_container module)
      ansible.builtin.pip:
        name: docker
        state: present
      tags: install_deps

    # --------------------------------------------------------------------------
    # ეტაპი 3: Docker-ის ოფიციალური GPG გასაღების დამატება (თანამედროვე მეთოდი)
    # --------------------------------------------------------------------------
    - name: Download Docker GPG key and register as a keyring
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'
        force: yes
      tags: install_docker

    # --------------------------------------------------------------------------
    # ეტაპი 4: Docker-ის სტაბილური რეპოზიტორიის დამატება
    # --------------------------------------------------------------------------
    - name: Add Docker stable repository
      ansible.builtin.apt_repository:
        # NOTE: signed-by იყენებს /etc/apt/keyrings/docker.asc (ახალი ფაილი)
        repo: "deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        update_cache: yes
      tags: install_docker

    # --------------------------------------------------------------------------
    # ეტაპი 5: Docker-ის ინსტალაცია
    # --------------------------------------------------------------------------
    - name: Install Docker Engine
      ansible.builtin.package:
        name: 
          - docker-ce
          - docker-ce-cli
          - containerd.io # ასოების სწორი თანმიმდევრობა
        state: present
      tags: install_docker
    
    # --------------------------------------------------------------------------
    # ეტაპი 6: Docker სერვისის გაშვება და მომხმარებლის დამატება
    # --------------------------------------------------------------------------
    - name: Start Docker service
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes
      tags: deploy
      
    # NOTE: ჩვენ ვუშვებთ Ansible-ს root-ით (-u root), ამიტომ ჯგუფში დამატება არ გვჭირდება,
    # მაგრამ თუ გვინდა ჩვეულებრივი მომხმარებლისთვის, საჭიროა. ამ ეტაპზე გამოვტოვოთ
    # გამარტივების მიზნით, რადგან root-ი ყველაფერს აკეთებს.

    # --------------------------------------------------------------------------
    # ეტაპი 7: Docker Container-ის გაშვება
    # --------------------------------------------------------------------------
    - name: Launch Nginx container on port 8080
      community.docker.docker_container:
        name: my_nginx_web
        image: nginx:latest
        state: started
        ports:
          - "80:80" # შევცვალოთ 8080-ით 80-ზე, რათა გამოვიყენოთ სტანდარტული HTTP პორტი
        restart_policy: always
      tags: deploy
