---
- name: Setup Docker and launch Nginx container
  hosts: web_servers
  become: yes
  gather_facts: yes
  pre_tasks:
    - name: Clean up old Docker repository files and keys
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/docker.list 
        - /etc/apt/keyrings/docker.asc      
        - /etc/apt/keyrings/docker.gpg      
        - /etc/apt/sources.list.d/docker.list.save # <-- დაამატეთ ეს
        - /etc/apt/sources.list.d/docker.list.d    # <-- დაამატეთ ეს
      tags: cleanup
    - name: Force delete any remaining old docker sources.list entry
      ansible.builtin.shell: |
        find /etc/apt/sources.list.d/ -type f -name '*docker*' -delete
      tags: cleanup
    - name: Ensure APT cache is reset after cleanup
      ansible.builtin.shell: rm -rf /var/lib/apt/lists/* && apt clean
      tags: cleanup

  tasks:
    # --------------------------------------------------------------------------
    # ეტაპი 1: Ubuntu-ს წინაპირობების ინსტალაცია
    # --------------------------------------------------------------------------
    # ამოცანა 1: იძულებით განახლება (APT-სთვის ინტერნეტი სჭირდება)
   
    - name: Install dependencies (curl, gnupg, etc.)
      ansible.builtin.apt:
        name:
          - curl
          - gnupg
          - lsb-release
          - ca-certificates
          - python3-pip
        state: present
      tags: install_deps
   
    


    - name: Install Docker Engine using official get-docker.sh script
      ansible.builtin.shell: |
        curl -fsSL https://get.docker.com -o get-docker.sh
        sh get-docker.sh
      tags: install_docker

    # --------------------------------------------------------------------------
    # ეტაპი 4: Python Docker SDK-ის ინსტალაცია (pip-ით)
    # --------------------------------------------------------------------------
    - name: Install Python Docker SDK using pip (due to apt conflicts)
      ansible.builtin.pip:
        name: docker
        state: present
      tags: install_deps

    # --------------------------------------------------------------------------
    # ეტაპი 5: Docker-ის სერვისის დაწყება (სკრიპტმა უნდა დააინსტალიროს იგი)
    # --------------------------------------------------------------------------
    - name: Start Docker service
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes
      tags: deploy

    # --------------------------------------------------------------------------
    # ეტაპი 6: Nginx-ის გაშვება
    # --------------------------------------------------------------------------
    - name: Launch Nginx container on port 8082
      community.docker.docker_container:
        name: my_nginx_web
        image: nginx:latest
        state: started
        ports:
          - "8082:80"
        restart_policy: always
      tags: deploy
