# .github/workflows/main.yml
# Full CI/CD Pipeline: Provision Infrastructure (Terraform) -> Configure/Deploy (Ansible) -> Destroy (Cleanup)

name: 'Full IaC & Configuration Deployment'

on:
  push:
    branches:
      - main
  workflow_dispatch: # საშუალებას იძლევა, ხელით გაეშვას

jobs:
  deploy_web_service:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      # --- ეტაპი 1: Terraform (Provisioning) ---
      
      - name: 2. Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.x

      - name: 3. Terraform Init
        run: terraform init -backend=false -var="do_token=${{ secrets.DIGITALOCEAN_TOKEN }}"
        working-directory: terraform-iac
      #  env:
      #    DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: 4. Terraform Apply (Create Droplet)
        id: apply
        run: terraform apply -auto-approve -var="do_token=${{ secrets.DIGITALOCEAN_TOKEN }}"
        working-directory: terraform-iac
      #  env:
      #    DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: 5. Get Droplet IP Address
        id: output
        run: |
          cd terraform-iac
          # IP-ის მიღება Terraform output-დან და შენახვა env-ში
          DROPLET_IP=$(terraform output -raw web_droplet_ip)
          echo "DROPLET_IP=$DROPLET_IP" >> $GITHUB_ENV

      # --- ეტაპი 2: Ansible (Configuration) ---

      - name: 6. Setup SSH Agent and Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # ეს Secret უნდა შეიცავდეს შენი Private SSH Key-ის შიგთავსს!
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: 7. Install Ansible & Dependencies
        run: pip install ansible

      - name: 8. Update Ansible Inventory (Dynamically)
        run: |
          # IP მისამართის ჩასწორება inventory.ini-ში
          sed -i "s/ansible_host=.*/ansible_host=${{ env.DROPLET_IP }}/" ansible-cm/inventory.ini

      - name: 9. Run Ansible Playbook (Deployment)
        run: ansible-playbook ansible-cm/docker-deployment.yml -i ansible-cm/inventory.ini

      # --- ეტაპი 3: Cleanup ---

      - name: 10. Terraform Destroy (Cleanup Infrastructure)
        if: always() # უზრუნველყოფს, რომ Destroy ყოველთვის გაეშვება, თუნდაც წინა ნაბიჯი ჩავარდეს
        run: terraform destroy -auto-approve -var="do_token=${{ secrets.DIGITALOCEAN_TOKEN }}"
        working-directory: terraform-iac
       # env:
       #   DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
